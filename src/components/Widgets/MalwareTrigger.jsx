import React, { useEffect, useState, useRef } from 'react';
import { useWindow } from '../../context/WindowContext';
import ClippyPopup from './ClippyPopup';
import PopupAd from './PopupAd';
import iconCmd from '../../assets/icons/cmd.png';

const MalwareTrigger = ({ windowId }) => {
    const { openWindow, closeWindow } = useWindow();
    const [log, setLog] = useState(["C:\\> start free_bitcoin.bat", "Initializing...", "Loading Payload..."]);
    const containerRef = useRef(null);

    useEffect(() => {
        let count = 0;
        const maxPopups = 20; // Safety limit

        const interval = setInterval(() => {
            if (count >= maxPopups) {
                clearInterval(interval);
                setLog(prev => [...prev, "Execution Complete.", "Cleaning up traces..."]);
                setTimeout(() => {
                    closeWindow(windowId);
                    openWindow(
                        `popup-final-${Date.now()}`,
                        'Assistant',
                        ClippyPopup,
                        null,
                        {
                            type: 'dialog',
                            message: "Gotcha! ðŸ˜œ Don't worry, it's just a prank. Click the Start button to refresh the screen!",
                            position: { x: window.innerWidth / 2 - 200, y: window.innerHeight / 2 - 100 }
                        }
                    );
                }, 2000); // Close after a delay
                return;
            }

            const randomX = Math.floor(Math.random() * (window.innerWidth - 300));
            const randomY = Math.floor(Math.random() * (window.innerHeight - 200));

            openWindow(
                `popup-${Date.now()}-${count}`,
                'Error',
                PopupAd,
                null,
                {
                    type: 'app', // Using 'app' to get the minimal window chrome we might want, or 'document'
                    position: { x: randomX, y: randomY },
                }
            );

            setLog(prev => [...prev, `Spawning instance ${count}: SUCCESS`, "Echoing to system..."]);
            count++;
        }, 300);

        return () => clearInterval(interval);
    }, []);

    // Auto-scroll logic safely
    useEffect(() => {
        if (containerRef.current) {
            containerRef.current.scrollTop = containerRef.current.scrollHeight;
        }
    }, [log]);

    return (
        <div
            ref={containerRef}
            className="h-full w-full bg-black text-gray-300 font-dos p-2 overflow-auto text-sm"
        >
            {log.map((line, i) => (
                <div key={i}>{line}</div>
            ))}
            <div className="animate-pulse">_</div>
        </div>
    );
};

export default MalwareTrigger;
